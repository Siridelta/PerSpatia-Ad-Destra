# Desmos Canvas 任务分配详细说明

> 这是给队友和AI助手的详细任务说明，确保大家能准确理解任务内容和目标

## 项目背景快速回顾

Desmos Canvas 是一个画布式编程环境，让用户可以在画布上拖拽代码块，实时预览Desmos图表。核心理念是"画布式、交互式、声明式创作"。

## 任务详细说明

### 高优先级任务

#### 1. 依赖表功能开发

**任务目标**：实现代码块之间的依赖关系管理，让变量能在不同代码块间传递。一个节点的依赖表分为两部分：输入变量表和输出变量表。输入变量表列出当前节点开始执行时会提供的上下文变量，输出变量表列出当前节点执行完成后留存、供后续节点使用的变量。

**详细分解**：

**阶段1：基础UI + 手动操作**
- 在每个节点的上下方各添加一个"依赖表"面板，分别代表输入变量表和输出变量表
- 支持在表中手动设置输入/输出变量项
- 取消原来的“控件作为输入”的方式，也即暂时不支持控件操控变量
- 支持节点间手动连线，连线后A代码块的输出变量将链接到B代码块的同名输入变量
- UI要简洁直观，可以参考Chrome开发者工具中CSS样式编辑区的交互逻辑（可以让AI设计多个方案，然后发到群里挑选）
- 此时依赖表里应有1种输入/输出变量类型：
  - 手动设置的输入/输出变量

**阶段2：@注解功能**

例如：
```javascript
const x, y; // @i
const z = 12; // @c 0:2:50; 创建一个滑动条控件，范围0-2，初始值50

const s = x + y + z;

const a = s ** 2; // @o
const b = s ** 0.5; // @o
```

- 实现 `@i` 和 `@o` 注解语法
- 添加 `@c` 注解，自动创建控件（滑动条->number、输入框->string、开关->boolean等）
- 重构控件创建逻辑，变为通过注解自动生成对应的交互控件
- 此时依赖表里应有2种输入/输出变量类型：
  - 手动设置的输入/输出变量
  - @注解指定的输入/输出变量
- 两类变量分组列在依赖表中

**🔴 阶段3：智能推断与自动对接**
- 自动分析代码，推断出"需要输入"和"可以输出"的变量
- 尝试自动匹配：如果A代码块输出x，B代码块需要输入x，就自动建立连接
- 实现"全局语义"效果：变量有"全局生效"感，类似Baba Is You游戏的体验，但可以关闭自动对接
- 提供开关分别控制一个节点的输入表、输出表是否参与自动对接
- 此时依赖表里应有3(+1)种输入/输出变量类型：
  - 手动设置的输入/输出变量
  - 手动排除的输入/输出变量
  - @注解指定的输入/输出变量
  - 自动推断的输入/输出变量
- 4类变量分组列在依赖表中；
- 一个变量可以在自动推断类、手动管理、或者手动否定之间相互切换，如果它能被自动推断出来的话；

**⚪ 阶段4：控件扩展功能**
- 添加更多控件类型（颜色选择器、下拉菜单等）
- 控件参数支持表达式（如 `@c slider(0, x*2, 5)`）
- 修改变量值时直接改变代码内容，实现类似Desmos的体验；控件与代码的双向同步
- 缓存控件参数和值，当带控件的变量被删除后重新添加时，能智能恢复之前的控件参数和值，类似Desmos的控件参数记忆功能
- 实现代码可变动之后，可以添加更多的变量转换操作：
    - 一个变量可以在手动设置类、注解指定类之间相互切换
    - 如果它能被自动推断出来，则可在手动设置类、注解指定类、自动推断类、手动否定类之间相互切换


**技术要点**：
- 需要解析代码中的变量声明和使用
- 依赖关系要可视化展示
- 状态管理要支持依赖图的保存/恢复

#### 2. Desmos预览组件

**任务目标**：让用户能在画布中实时看到Desmos图表效果

**详细分解**：

**阶段1：无Bernard库的预览**
- 支持根据state json生成Desmos图像
- 在画布中嵌入Desmos iframe，并使用Desmos API设置其state json，从而设置图像内容

**阶段2：集成Bernard库**
- 引入Bernard.js库
- 与前面的 state json 生成逻辑对接, 用户使用Bernard.js库构建图象对象、并导出state json，然后再渲染为Desmos图像，跑通这个流程

**🔴 阶段3：完整集成**
- Bernard深度集成：
    - Bernard 变量定义表达式对象可以拥有控件，像操纵Desmos控件一样操纵Bernard变量定义表达式
    - 支持显示 Bernard 对象的更多类型信息
    - 支持Bernard的代码预处理(preprocess)，如 `` const a = expl`13.5`; `` -> ``const a = expl`a = 13.5`;`` 提供更好的开发体验
- 实现公式与错误信息的逆转译（Bernard导出图像时会转译部分表达式，并对变量进行重命名，逆转译即根据画布内的已有信息，将Desmos公式转换为对开发者熟悉、可读的Bernard表达式）
- 实现三栏式视图：Desmos预览区（无公式显示）+ Desmos公式列表区（自制，使用MathQuill渲染；显示错误信息）+ 还原区（显示根据画布上下文逆转译回来的Bernard表达式和可读的错误信息）

**技术要点**：
- 需要研究Desmos API的使用
- Bernard库的集成方式
- 实时预览的性能优化

#### 🔴 3. TextNode代码编辑器重构

**任务目标**：重新实现代码编辑器，提升编辑体验

**当前问题**：
- 现在的编辑器能勉强编辑，但不好用
- 需要更好的语法高亮
- 需要更好的光标控制
- 需要更好的代码提示

**重构要点**：
- 学习参考Monaco Editor机制
- 语法高亮
- ⚪代码补全
- ⚪优化编辑器的响应性能

#### 🔴 4. Bernard.js库开发

**任务目标**：开发JavaScript版本的Bernard库，为Desmos Canvas提供数学表达式编程框架

**核心功能**：
- 数学表达式的解析和建模
- 将代码转换为Desmos可识别的格式
- 支持变量引用、函数调用、运算表达式等基本元素
- 提供接近数学表达习惯的语法
- 自动处理表达式之间的依赖关系
- 生成Desmos state json供预览使用
- 与Desmos Canvas无缝集成，实现代码到图表的实时转换

### 低优先级任务（短期非必需，可以延后）

#### ⚪ fix: 保存/未保存状态

**任务目标**：修复文件保存状态管理的bug

**当前问题**：
- 保存状态可能不准确
- 交互逻辑不够好

**修复内容**：
- 修复保存状态逻辑
- 优化交互提示

#### ⚪ fix: 导入导出功能

**任务目标**：修复导入导出功能的bug

**当前问题**：
- 导入时可能出错

**修复内容**：
- 修复导入功能

#### ⚪ 三维摄像机控制

**任务目标**：建立统一的三维摄像机系统，将画布的移动和缩放重新理解为摄像机的上下左右和前后移动，追求像游戏一样方便的交互体验；同时整理按键移动控制的逻辑，使用算法实现更自然的、三维概念的移动；也为后续的3D动画背景打下基础。

**具体内容**：
- 实现摄像机坐标系统
- 整理按键移动逻辑，将画布的移动和缩放重新理解为摄像机的上下左右和前后移动
- 使用算法实现更自然的、三维概念的移动


## 开发注意事项

### 技术栈
- 前端：React 19 + TypeScript + Vite + TailwindCSS
- 画布：React Flow
- 状态管理：Zustand
- 包管理：pnpm

### 代码风格
- 暂无要求

### 协作方式
- vibe coding
- 有问题及时沟通
- 常上线交流
- 代码提交前先本地测试

### 颜色说明
- 🔴 红色：需要static亲手做，核心功能
- ⚪ 灰色：低优先级任务，可以延后
- 其他为优先考虑的分配任务。

## 问题反馈

如果在开发过程中遇到理解偏差或技术问题，请及时反馈。这个文档会持续更新，确保大家都能准确理解任务目标。
